<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OkCity Music Links</title>
    <script src="config.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 480px; margin: 0 auto; padding: 20px; text-align: center; background-color: #f9f9f9; }
        h1 { color: #333; margin-bottom: 30px; }
        input { display: block; width: 100%; box-sizing: border-box; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        button { width: 100%; padding: 12px; background: #222; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #444; }
        .auth-toggle { color: #666; font-size: 0.9em; margin-top: 15px; cursor: pointer; text-decoration: underline; }
        .user-list { margin-top: 40px; text-align: left; }
        .user-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
        .user-card:hover { transform: translateY(-2px); }
        .user-card img { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .user-card b { font-size: 1.1em; color: #333; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ðŸŽµ OkCity Music</h1>
    
    <div id="login-box">
        <input type="email" id="l-email" placeholder="Email">
        <input type="password" id="l-pass" placeholder="å¯†ç¢¼">
        <button onclick="handleLogin()">ç™»å…¥</button>
        <div class="auth-toggle" onclick="toggleAuth()">æ²’æœ‰å¸³è™Ÿï¼Ÿé»žæ­¤è¨»å†Š</div>
    </div>

    <div id="register-box" class="hidden">
        <input type="text" id="r-name" placeholder="ä½ çš„æš±ç¨± / è—å">
        <input type="email" id="r-email" placeholder="Email">
        <input type="password" id="r-pass" placeholder="å¯†ç¢¼">
        <button onclick="handleRegister()">è¨»å†Š</button>
        <div class="auth-toggle" onclick="toggleAuth()">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›žç™»å…¥</div>
    </div>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #eee;">
    
    <h3>ðŸŒŸ æŽ¢ç´¢å‰µä½œè€…</h3>
    <div id="creators-list" class="user-list">è¼‰å…¥ä¸­...</div>

    <script>
        // æª¢æŸ¥ CONFIG æ˜¯å¦æ­£ç¢ºè¼‰å…¥
        const API_URL = typeof CONFIG !== 'undefined' ? CONFIG.API_URL : "";

        function toggleAuth() {
            document.getElementById('login-box').classList.toggle('hidden');
            document.getElementById('register-box').classList.toggle('hidden');
        }

        async function handleLogin() {
            if(!API_URL) return alert("é…ç½®éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° API URL");
            const btn = document.querySelector('#login-box button');
            btn.innerText = "ç™»å…¥ä¸­...";
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "login",
                        email: document.getElementById('l-email').value,
                        password: document.getElementById('l-pass').value
                    })
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem("uid", data.uid);
                    window.location.href = `user.html?uid=${data.uid}`;
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS éƒ¨ç½²ç‹€æ…‹");
            } finally {
                btn.innerText = "ç™»å…¥";
            }
        }

        async function handleRegister() {
            if(!API_URL) return alert("é…ç½®éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° API URL");
            const btn = document.querySelector('#register-box button');
            btn.innerText = "è¨»å†Šä¸­...";
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "register",
                        name: document.getElementById('r-name').value,
                        email: document.getElementById('r-email').value,
                        password: document.getElementById('r-pass').value
                    })
                });
                const data = await res.json();
                if(data.success) {
                    alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
                    toggleAuth();
                } else {
                    alert("è¨»å†Šå¤±æ•—ï¼š" + data.message);
                }
            } catch (e) {
                alert("é€£ç·šå¤±æ•—");
            } finally {
                btn.innerText = "è¨»å†Š";
            }
        }

        // è¼‰å…¥å‰µä½œè€…åˆ—è¡¨
        if (API_URL) {
            fetch(`${API_URL}?action=getUsers`)
                .then(r => r.json())
                .then(users => {
                    const list = document.getElementById('creators-list');
                    if (users.length === 0) {
                        list.innerHTML = "ç›®å‰å°šç„¡å‰µä½œè€…";
                        return;
                    }
                    list.innerHTML = users.map(u => `
                        <div class="user-card" onclick="location.href='user.html?uid=${u.uid}'">
                            <img src="${u.profileImage}" onerror="this.src='https://via.placeholder.com/45'">
                            <b>${u.name}</b>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    document.getElementById('creators-list').innerHTML = "ç„¡æ³•è¼‰å…¥å‰µä½œè€…åˆ—è¡¨";
                });
        }
    </script>
</body>
</html>
